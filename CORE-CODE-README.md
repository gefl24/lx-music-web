# LX Music Web - æ ¸å¿ƒä»£ç å®ç°è¯´æ˜

## ğŸ“¦ å·²å®Œæˆçš„æ ¸å¿ƒæ¨¡å—

æœ¬æ¬¡äº¤ä»˜åŒ…å« LX Music Web é¡¹ç›®çš„**å®Œæ•´åç«¯æ ¸å¿ƒä»£ç **,å¯ä»¥ç›´æ¥è¿è¡Œã€‚

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
lx-music-web/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡å— â­
â”‚   â”‚   â”‚   â”œâ”€â”€ SourceEngine.js      # è‡ªå®šä¹‰æºæ‰§è¡Œå¼•æ“ (500+ è¡Œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ DownloadManager.js   # ä¸‹è½½ç®¡ç†å™¨ (450+ è¡Œ)
â”‚   â”‚   â”‚   â””â”€â”€ DatabaseManager.js   # æ•°æ®åº“ç®¡ç†å™¨ (150+ è¡Œ)
â”‚   â”‚   â”œâ”€â”€ routes/                  # API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ music.js            # éŸ³ä¹ç›¸å…³æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ download.js         # ä¸‹è½½ç›¸å…³æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ source.js           # éŸ³æºç®¡ç†æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ proxy.js            # éŸ³é¢‘ä»£ç†æ¥å£
â”‚   â”‚   â””â”€â”€ app.js                  # Express åº”ç”¨ä¸»æ–‡ä»¶ (200+ è¡Œ)
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ test-source.js          # æµ‹è¯•ç”¨è‡ªå®šä¹‰æº
â”‚   â”œâ”€â”€ index.js                    # æœåŠ¡å™¨å…¥å£
â”‚   â”œâ”€â”€ package.json                # ä¾èµ–é…ç½®
â”‚   â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â””â”€â”€ README.md                   # ä½¿ç”¨æ–‡æ¡£
â””â”€â”€ client/                         # å‰ç«¯ä»£ç  (å¾…å¼€å‘)
```

---

## ğŸ¯ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. SourceEngine.js - è‡ªå®šä¹‰æºæ‰§è¡Œå¼•æ“

**è¿™æ˜¯æ•´ä¸ªé¡¹ç›®æœ€æ ¸å¿ƒçš„æ¨¡å—!**

#### åŠŸèƒ½ç‰¹æ€§
- âœ… ä½¿ç”¨ `vm2` åˆ›å»ºå®‰å…¨æ²™ç›’ç¯å¢ƒ
- âœ… å®Œæ•´å®ç° `lx` API å…¼å®¹å±‚
  - `lx.request()` - HTTP è¯·æ±‚ä»£ç†
  - `lx.utils.crypto.*` - åŠ å¯†å·¥å…· (MD5, AES, RSA)
  - `lx.utils.buffer.*` - Buffer æ“ä½œ
  - `lx.utils.zlib.*` - å‹ç¼©å·¥å…·
- âœ… æ”¯æŒå¤šä¸ªè‡ªå®šä¹‰æºå¹¶å­˜
- âœ… è¯·æ±‚ç»“æœç¼“å­˜ (æå‡æ€§èƒ½)
- âœ… äº‹ä»¶ç³»ç»Ÿ (EventEmitter)

#### æ ¸å¿ƒæ–¹æ³•
```javascript
// åŠ è½½è‡ªå®šä¹‰æº
await sourceEngine.loadSource(sourceId, scriptCode)

// æœç´¢éŸ³ä¹
await sourceEngine.search(sourceId, keyword, page)

// è·å–æ’­æ”¾é“¾æ¥
await sourceEngine.getMusicUrl(sourceId, songInfo, quality)

// è·å–æ­Œè¯
await sourceEngine.getLyric(sourceId, songInfo)
```

#### ä»£ç äº®ç‚¹
- ä½¿ç”¨ `vm2` éš”ç¦»æ‰§è¡Œè‡ªå®šä¹‰æºè„šæœ¬,é˜²æ­¢æ¶æ„ä»£ç 
- å®Œæ•´çš„ Polyfill å®ç°,å…¼å®¹æµè§ˆå™¨ç¯å¢ƒçš„è‡ªå®šä¹‰æº
- æ”¯æŒ Promise å’Œ Callback ä¸¤ç§è°ƒç”¨æ–¹å¼

---

### 2. DownloadManager.js - ä¸‹è½½ç®¡ç†å™¨

#### åŠŸèƒ½ç‰¹æ€§
- âœ… é˜Ÿåˆ—ç®¡ç† (å…ˆè¿›å…ˆå‡º)
- âœ… å¹¶å‘æ§åˆ¶ (å¯é…ç½®æœ€å¤§å¹¶å‘æ•°)
- âœ… æ–­ç‚¹ç»­ä¼  (æ”¯æŒ Range è¯·æ±‚)
- âœ… å¤±è´¥è‡ªåŠ¨é‡è¯• (å¯é…ç½®é‡è¯•æ¬¡æ•°)
- âœ… å®æ—¶è¿›åº¦æ¨é€ (EventEmitter)
- âœ… ä»»åŠ¡æŒä¹…åŒ– (æ•°æ®åº“å­˜å‚¨)
- âœ… æš‚åœ/æ¢å¤åŠŸèƒ½

#### æ ¸å¿ƒæ–¹æ³•
```javascript
// æ·»åŠ ä¸‹è½½ä»»åŠ¡
await downloadManager.addTask(songInfo, quality, source)

// æš‚åœä»»åŠ¡
downloadManager.pauseTask(taskId)

// æ¢å¤ä»»åŠ¡
downloadManager.resumeTask(taskId)

// è·å–ä»»åŠ¡åˆ—è¡¨
downloadManager.getTasks(status, limit)
```

#### ä»£ç äº®ç‚¹
- æµå¼ä¸‹è½½,å†…å­˜å ç”¨ä½
- æ”¯æŒæ–­ç‚¹ç»­ä¼ ,èŠ‚çœå¸¦å®½
- è‡ªåŠ¨ä»æ•°æ®åº“æ¢å¤æœªå®Œæˆä»»åŠ¡

---

### 3. DatabaseManager.js - æ•°æ®åº“ç®¡ç†å™¨

#### åŠŸèƒ½ç‰¹æ€§
- âœ… SQLite æ•°æ®åº“å°è£…
- âœ… WAL æ¨¡å¼ (æå‡å¹¶å‘æ€§èƒ½)
- âœ… å®Œæ•´çš„è¡¨ç»“æ„è®¾è®¡
- âœ… æ•°æ®å¤‡ä»½åŠŸèƒ½
- âœ… è‡ªåŠ¨æ¸…ç†å†å²æ•°æ®

#### æ•°æ®è¡¨
- `downloads` - ä¸‹è½½ä»»åŠ¡
- `playlists` - æ’­æ”¾åˆ—è¡¨
- `playlist_songs` - æ’­æ”¾åˆ—è¡¨æ­Œæ›²
- `play_history` - æ’­æ”¾å†å²
- `custom_sources` - è‡ªå®šä¹‰æº
- `app_config` - åº”ç”¨é…ç½®

---

### 4. API è·¯ç”±æ¨¡å—

#### music.js - éŸ³ä¹ç›¸å…³æ¥å£
- `POST /api/music/search` - æœç´¢éŸ³ä¹
- `POST /api/music/url` - è·å–æ’­æ”¾é“¾æ¥
- `POST /api/music/lyric` - è·å–æ­Œè¯
- `GET /api/music/leaderboard/:source` - è·å–æ¦œå•

#### download.js - ä¸‹è½½ç›¸å…³æ¥å£
- `POST /api/download/add` - æ·»åŠ ä¸‹è½½ä»»åŠ¡
- `GET /api/download/list` - è·å–ä¸‹è½½åˆ—è¡¨
- `POST /api/download/pause` - æš‚åœä¸‹è½½
- `POST /api/download/resume` - æ¢å¤ä¸‹è½½
- `DELETE /api/download/:id` - åˆ é™¤ä»»åŠ¡

#### source.js - éŸ³æºç®¡ç†æ¥å£
- `GET /api/source/list` - è·å–éŸ³æºåˆ—è¡¨
- `POST /api/source/upload` - ä¸Šä¼ è‡ªå®šä¹‰æº
- `DELETE /api/source/:id` - åˆ é™¤éŸ³æº
- `POST /api/source/toggle` - å¯ç”¨/ç¦ç”¨éŸ³æº

#### proxy.js - éŸ³é¢‘ä»£ç†æ¥å£
- `GET /api/proxy/stream` - ä»£ç†éŸ³é¢‘æµ (è§£å†³é˜²ç›—é“¾)

---

### 5. app.js - Express åº”ç”¨ä¸»æ–‡ä»¶

#### åŠŸèƒ½ç‰¹æ€§
- âœ… æ•´åˆæ‰€æœ‰æ ¸å¿ƒæ¨¡å—
- âœ… ä¸­é—´ä»¶é…ç½® (CORS, JSON è§£æ)
- âœ… è·¯ç”±æ³¨å†Œ
- âœ… WebSocket æ”¯æŒ (Socket.io)
- âœ… é™æ€æ–‡ä»¶æœåŠ¡
- âœ… é”™è¯¯å¤„ç†
- âœ… ä¼˜é›…å…³é—­

#### WebSocket äº‹ä»¶
- `download:progress` - ä¸‹è½½è¿›åº¦æ›´æ–°
- `download:completed` - ä¸‹è½½å®Œæˆ
- `download:failed` - ä¸‹è½½å¤±è´¥

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

```bash
cd lx-music-web/server
npm install
```

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶,ä¿®æ”¹é…ç½®
```

### æ­¥éª¤ 3: å¯åŠ¨æœåŠ¡å™¨

```bash
npm start
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

### æ­¥éª¤ 4: æµ‹è¯•åŠŸèƒ½

#### ä¸Šä¼ æµ‹è¯•æº
```bash
curl -X POST http://localhost:3000/api/source/upload \
  -F "source=@tests/test-source.js"
```

#### æœç´¢éŸ³ä¹
```bash
curl -X POST http://localhost:3000/api/music/search \
  -H "Content-Type: application/json" \
  -d '{"keyword":"æµ‹è¯•","source":"test","page":1}'
```

#### æ·»åŠ ä¸‹è½½
```bash
curl -X POST http://localhost:3000/api/download/add \
  -H "Content-Type: application/json" \
  -d '{
    "songInfo": {"id":"1001","name":"ç¤ºä¾‹æ­Œæ›²1","singer":"ç¤ºä¾‹æ­Œæ‰‹"},
    "quality":"128k",
    "source":"test"
  }'
```

---

## ğŸ“Š æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Node.js | 16+ | è¿è¡Œæ—¶ç¯å¢ƒ |
| Express | 4.18+ | Web æ¡†æ¶ |
| Socket.io | 4.6+ | WebSocket é€šä¿¡ |
| better-sqlite3 | 9.2+ | SQLite æ•°æ®åº“ |
| vm2 | 3.9+ | å®‰å…¨æ²™ç›’ |
| node-fetch | 2.7+ | HTTP è¯·æ±‚ |
| multer | 1.4+ | æ–‡ä»¶ä¸Šä¼  |

---

## ğŸ”‘ æ ¸å¿ƒä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| SourceEngine.js | 500+ | è‡ªå®šä¹‰æºæ‰§è¡Œå¼•æ“ |
| DownloadManager.js | 450+ | ä¸‹è½½ç®¡ç†å™¨ |
| DatabaseManager.js | 150+ | æ•°æ®åº“ç®¡ç†å™¨ |
| app.js | 200+ | Express åº”ç”¨ |
| music.js | 150+ | éŸ³ä¹ API |
| download.js | 180+ | ä¸‹è½½ API |
| source.js | 200+ | éŸ³æºç®¡ç† API |
| proxy.js | 80+ | éŸ³é¢‘ä»£ç† |
| **æ€»è®¡** | **2000+** | **å®Œæ•´åç«¯å®ç°** |

---

## âœ… å·²å®ç°åŠŸèƒ½æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [x] è‡ªå®šä¹‰æºåŠ è½½ä¸æ‰§è¡Œ
- [x] éŸ³ä¹æœç´¢
- [x] æ’­æ”¾é“¾æ¥è·å–
- [x] æ­Œè¯è·å–
- [x] æ¦œå•è·å–
- [x] æœåŠ¡å™¨ç«¯ä¸‹è½½
- [x] ä¸‹è½½é˜Ÿåˆ—ç®¡ç†
- [x] æ–­ç‚¹ç»­ä¼ 
- [x] ä¸‹è½½è¿›åº¦æ¨é€
- [x] éŸ³é¢‘æµä»£ç† (é˜²ç›—é“¾)

### æ•°æ®åº“åŠŸèƒ½
- [x] ä¸‹è½½ä»»åŠ¡ç®¡ç†
- [x] æ’­æ”¾åˆ—è¡¨ç®¡ç†
- [x] æ’­æ”¾å†å²è®°å½•
- [x] è‡ªå®šä¹‰æºç®¡ç†
- [x] åº”ç”¨é…ç½®å­˜å‚¨

### API æ¥å£
- [x] RESTful API è®¾è®¡
- [x] å‚æ•°éªŒè¯
- [x] é”™è¯¯å¤„ç†
- [x] è¯·æ±‚æ—¥å¿—

### WebSocket
- [x] å®æ—¶è¿›åº¦æ¨é€
- [x] åŒå‘é€šä¿¡
- [x] äº‹ä»¶é©±åŠ¨

---

## ğŸ¨ å¾…å¼€å‘æ¨¡å—

### å‰ç«¯éƒ¨åˆ† (ä¼˜å…ˆçº§ P0)
- [ ] Vue 3 åº”ç”¨æ¡†æ¶
- [ ] æœç´¢ç•Œé¢
- [ ] éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶
- [ ] ä¸‹è½½ç®¡ç†ç•Œé¢
- [ ] éŸ³æºç®¡ç†ç•Œé¢
- [ ] è®¾ç½®é¡µé¢

### å¢å¼ºåŠŸèƒ½ (ä¼˜å…ˆçº§ P1)
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
- [ ] æ”¶è—åŠŸèƒ½
- [ ] æ’­æ”¾å†å²
- [ ] éŸ³ä¹æ ‡ç­¾

### éƒ¨ç½²ç›¸å…³ (ä¼˜å…ˆçº§ P1)
- [ ] Dockerfile
- [ ] docker-compose.yml
- [ ] Nginx é…ç½®
- [ ] CI/CD æµç¨‹

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
```bash
# å®‰è£…æµ‹è¯•æ¡†æ¶
npm install --save-dev jest supertest

# ç¼–å†™æµ‹è¯•ç”¨ä¾‹
# tests/SourceEngine.test.js
# tests/DownloadManager.test.js
# tests/api.test.js

# è¿è¡Œæµ‹è¯•
npm test
```

### é›†æˆæµ‹è¯•
1. æµ‹è¯•è‡ªå®šä¹‰æºåŠ è½½
2. æµ‹è¯•æœç´¢åŠŸèƒ½
3. æµ‹è¯•ä¸‹è½½æµç¨‹
4. æµ‹è¯•éŸ³é¢‘ä»£ç†

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›æ–¹å‘

### é—®é¢˜
1. `vm2` å·²åœæ­¢ç»´æŠ¤,å»ºè®®è¿ç§»åˆ° `isolated-vm`
2. ç¼ºå°‘è¯·æ±‚é€Ÿç‡é™åˆ¶
3. ç¼ºå°‘ç”¨æˆ·è®¤è¯

### æ”¹è¿›æ–¹å‘
1. **æ€§èƒ½ä¼˜åŒ–**
   - å¼•å…¥ Redis ç¼“å­˜
   - Node.js Cluster å¤šè¿›ç¨‹
   
2. **å®‰å…¨åŠ å›º**
   - æ·»åŠ  CORS ç™½åå•
   - å®ç° JWT è®¤è¯
   - æ·»åŠ è¯·æ±‚é€Ÿç‡é™åˆ¶

3. **åŠŸèƒ½å¢å¼º**
   - æ”¯æŒæ­Œå•å¯¼å…¥/å¯¼å‡º
   - æ”¯æŒå¤šç”¨æˆ·ç³»ç»Ÿ
   - æ”¯æŒéŸ³ä¹æ ‡ç­¾å’Œåˆ†ç±»

---

## ğŸ“š å¼€å‘æ–‡æ¡£

### è‡ªå®šä¹‰æºå¼€å‘æŒ‡å—

è‡ªå®šä¹‰æºå¿…é¡»å®ç°ä»¥ä¸‹æ–¹æ³•:

```javascript
// æœç´¢ (å¿…éœ€)
globalThis.search = async ({ keyword, page, limit }) => {
  return [{ id, name, singer, album, duration }]
}

// è·å–æ’­æ”¾é“¾æ¥ (å¿…éœ€)
globalThis.getUrl = async ({ songInfo, quality }) => {
  return 'https://example.com/song.mp3'
}

// è·å–æ­Œè¯ (å¯é€‰)
globalThis.getLyric = async ({ songInfo }) => {
  return '[00:00.00]æ­Œè¯å†…å®¹'
}
```

### å¯ç”¨ API

- `lx.request(url, options, callback)` - HTTP è¯·æ±‚
- `lx.utils.crypto.md5(data)` - MD5
- `lx.utils.crypto.aesEncrypt()` - AES åŠ å¯†
- `lx.utils.buffer.from()` - Buffer åˆ›å»º
- `lx.utils.zlib.gzip()` - Gzip å‹ç¼©

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

---

## ğŸ“„ è®¸å¯è¯

Apache License 2.0

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯åš
1. âœ… **æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½** - ä½¿ç”¨æä¾›çš„æµ‹è¯•æºéªŒè¯æ‰€æœ‰ API
2. âœ… **å¼€å‘å‰ç«¯ç•Œé¢** - åŸºäº Vue 3 å¼€å‘ Web ç•Œé¢
3. âœ… **Docker åŒ–** - ç¼–å†™ Dockerfile å’Œ docker-compose.yml

### çŸ­æœŸè®¡åˆ’ (1-2 å‘¨)
1. å®Œæˆå‰ç«¯æ ¸å¿ƒé¡µé¢ (æœç´¢ã€æ’­æ”¾ã€ä¸‹è½½)
2. å®ç°éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶
3. å®Œæˆ Docker éƒ¨ç½²æ–¹æ¡ˆ

### ä¸­æœŸè®¡åˆ’ (1 ä¸ªæœˆ)
1. æ·»åŠ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
2. å®ç°æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
3. æ€§èƒ½ä¼˜åŒ– (Redis ç¼“å­˜)

---

**é¡¹ç›®çŠ¶æ€**: åç«¯æ ¸å¿ƒå·²å®Œæˆ âœ… | å‰ç«¯å¼€å‘ä¸­ ğŸš§ | Docker å¾…å®Œæˆ â³

**æœ€åæ›´æ–°**: 2026-01-28
